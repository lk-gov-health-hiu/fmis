<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://xmlns.jcp.org/jsf/composite"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <cc:interface>
    </cc:interface>
    <cc:implementation>
        <!-- Mobile Toggle Button -->
        <button class="navbar-toggler custom-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#mainNavMenu"
                aria-controls="mainNavMenu" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-list"></i>
        </button>

        <!-- Collapsible Menu -->
        <div class="collapse navbar-collapse" id="mainNavMenu">
            <ul class="navbar-nav ms-auto">
                <h:form id="menuForm" styleClass="d-contents">

                    <!-- Home -->
                    <ui:fragment rendered="#{webUserController.dashboardAvailable}">
                        <li class="nav-item">
                            <h:commandLink styleClass="nav-link" action="#{menuController.toIndex()}">
                                <i class="bi bi-house-door me-1"></i> Home
                            </h:commandLink>
                        </li>
                    </ui:fragment>

                    <!-- Diesel Orders Dropdown -->
                    <ui:fragment rendered="#{webUserController.dieselMenuAvailable}">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-fuel-pump me-1"></i> Diesel Orders
                            </a>
                            <ul class="dropdown-menu">
                                <ui:fragment rendered="#{webUserController.dieselFuelRequestMenuAvailable}">
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{fuelRequestAndIssueController.navigateToAddVehicleFuelRequest()}">
                                            Create Order
                                        </h:commandLink>
                                    </li>
                                </ui:fragment>
                                <ui:fragment rendered="#{webUserController.dieselSpecialFuelRequestMenuAvailable}">
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{fuelRequestAndIssueController.navigateToAddSpecialVehicleFuelRequest()}">
                                            Create Special Order
                                        </h:commandLink>
                                    </li>
                                </ui:fragment>
                                <ui:fragment rendered="#{webUserController.dieselFuelRequestMarkAsReceivedMenuAvailable}">
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{fuelRequestAndIssueController.navigateToListInstitutionRequestsToMark()}">
                                            Mark Received Orders
                                        </h:commandLink>
                                    </li>
                                </ui:fragment>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToListInstitutionRequests()}">
                                        View Orders
                                    </h:commandLink>
                                </li>
                                <ui:fragment rendered="#{webUserController.institutionPaymentManagementMenuAvailable or webUserController.systemAdminPaymentManagementMenuAvailable}">
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{fuelRequestAndIssueController.navigateToMakePayment()}">
                                            Make Payment Orders
                                        </h:commandLink>
                                    </li>
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{fuelRequestAndIssueController.navigateToPaymentsMade()}">
                                            Previously Completed Payments
                                        </h:commandLink>
                                    </li>
                                </ui:fragment>
                            </ul>
                        </li>
                    </ui:fragment>

                    <!-- Payment Management Dropdown -->
                    <ui:fragment rendered="#{webUserController.institutionPaymentManagementMenuAvailable or webUserController.systemAdminPaymentManagementMenuAvailable}">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-credit-card me-1"></i> Payments
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToListPaymentBills()}">
                                        Payment Bills
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToListBillsToAcceptAtCpc()}">
                                        Payments to Accept at CPC
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToListBillsAcceptedByCpc()}">
                                        Payments Accepted by CPC
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToListBillsRejectedByCpc()}">
                                        Payments Rejected by CPC
                                    </h:commandLink>
                                </li>
                            </ul>
                        </li>
                    </ui:fragment>

                    <!-- CPC Payment Management Dropdown -->
                    <ui:fragment rendered="#{webUserController.cpcPaymentManagementMenuAvailable}">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-bank me-1"></i> CPC Payments
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToCpcListPaymentBills()}">
                                        Payment Bills
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToCpcListBillsToAccept()}">
                                        Payments to Accept
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToCpcListBillsAccepted()}">
                                        Payments Accepted
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToCpcListBillsRejected()}">
                                        Payments Rejected
                                    </h:commandLink>
                                </li>
                            </ul>
                        </li>
                    </ui:fragment>

                    <!-- List of Transactions -->
                    <ui:fragment rendered="#{webUserController.reportsMenuAvailable}">
                        <li class="nav-item">
                            <h:commandLink styleClass="nav-link" action="#{reportController.navigateToListFuelRequests()}">
                                <i class="bi bi-list me-1"></i> List of Transactions
                            </h:commandLink>
                        </li>
                    </ui:fragment>

                    <!-- Reports -->
                    <ui:fragment rendered="#{webUserController.reportsMenuAvailable}">
                        <li class="nav-item">
                            <h:commandLink styleClass="nav-link" action="#{reportController.navigateToReportsIndex}">
                                <i class="bi bi-bar-chart me-1"></i> Reports
                            </h:commandLink>
                        </li>
                    </ui:fragment>

                    <!-- Administration Dropdown -->
                    <ui:fragment rendered="#{webUserController.administrationMenuAvailable}">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear me-1"></i> Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{menuController.toAdministrationIndex()}">
                                        Administration Home
                                    </h:commandLink>
                                </li>
                                <li><hr class="dropdown-divider" /></li>

                                <!-- System Messaging (Only for System Admin and Super User) -->
                                <ui:fragment rendered="#{webUserController.loggedUser.systemAdministrator or webUserController.loggedUser.superUser}">
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="#{systemMessageController.prepareCreateMessage()}">
                                            <i class="bi bi-envelope-plus me-2"></i> Create System Message
                                        </h:commandLink>
                                    </li>
                                    <li>
                                        <h:commandLink styleClass="dropdown-item"
                                                       action="/systemAdmin/view_sent_messages">
                                            <i class="bi bi-send me-2"></i> View Sent Messages
                                        </h:commandLink>
                                    </li>
                                    <li><hr class="dropdown-divider" /></li>
                                </ui:fragment>

                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{fuelRequestAndIssueController.navigateToMigrateBillItems()}">
                                        Migrate Bill Items
                                    </h:commandLink>
                                </li>
                            </ul>
                        </li>
                    </ui:fragment>

                    <!-- Settings Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-sliders me-1"></i> Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <h:commandLink styleClass="dropdown-item"
                                               action="#{webUserController.toChangeMyPassword()}">
                                    Change My Password
                                </h:commandLink>
                            </li>
                            <ui:fragment rendered="#{webUserController.settingsMenuItemAvailable}">
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{webUserController.toChangeMyDetails()}">
                                        Change My Details
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{webUserController.toChangeMyUsername()}">
                                        Change My Username
                                    </h:commandLink>
                                </li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{apiKeyController.toManageMyApiKeys()}">
                                        API Keys
                                    </h:commandLink>
                                </li>
                            </ui:fragment>
                            <ui:fragment rendered="#{webUserController.hasPrivilege('Institution_Administration') and webUserController.settingsMenuItemAvailable}">
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <h:commandLink styleClass="dropdown-item"
                                                   action="#{webUserController.toChangeMyInstitutionDetails()}">
                                        Change Institution Details
                                    </h:commandLink>
                                </li>
                            </ui:fragment>
                        </ul>
                    </li>

                    <!-- Help Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-question-circle me-1"></i> Help
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="https://github.com/lk-gov-health-hiu/fmis/wiki" target="_blank">
                                    <i class="bi bi-book me-2"></i> User Manual
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="https://github.com/lk-gov-health-hiu/fmis/issues" target="_blank">
                                    <i class="bi bi-bug me-2"></i> Issue Tracking
                                </a>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <h:commandLink styleClass="dropdown-item" action="/about_us">
                                    <i class="bi bi-info-circle me-2"></i> About
                                </h:commandLink>
                            </li>
                        </ul>
                    </li>

                    <!-- Notifications Bell -->
                    <li class="nav-item dropdown">
                        #{systemMessageController.refreshUnreadMessages()}
                        <a class="nav-link position-relative" href="#"
                           id="notificationDropdown"
                           role="button"
                           data-bs-toggle="dropdown"
                           aria-expanded="false">
                            <i class="bi bi-bell-fill fs-5"></i>
                            <h:panelGroup rendered="#{systemMessageController.unreadCount > 0}">
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    #{systemMessageController.unreadCount}
                                    <span class="visually-hidden">unread messages</span>
                                </span>
                            </h:panelGroup>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 400px; max-height: 500px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <strong>Notifications</strong>
                            </li>
                            <li><hr class="dropdown-divider"/></li>

                            <!-- Unread Messages List -->
                            <h:panelGroup rendered="#{systemMessageController.unreadCount == 0}">
                                <li class="dropdown-item text-center text-muted">
                                    No new notifications
                                </li>
                            </h:panelGroup>

                            <ui:repeat value="#{systemMessageController.unreadMessages}"
                                       var="msgStatus"
                                       varStatus="status">
                                <li>
                                    <h:commandLink action="#{systemMessageController.viewMessage(msgStatus)}"
                                                   styleClass="dropdown-item py-3">
                                        <div class="d-flex align-items-start">
                                            <!-- Icon based on message type -->
                                            <i class="bi #{msgStatus.systemMessage.messageType.icon} text-#{msgStatus.systemMessage.messageType.colorClass} me-2 fs-5"></i>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <strong>#{msgStatus.systemMessage.subject}</strong>
                                                    <!-- Priority badge -->
                                                    <span class="badge bg-#{msgStatus.systemMessage.priority.colorClass} ms-2">
                                                        #{msgStatus.systemMessage.priority.label}
                                                    </span>
                                                </div>
                                                <p class="mb-1 small text-muted">
                                                    <h:outputText value="#{msgStatus.deliveredAt}">
                                                        <f:convertDateTime pattern="MMM dd, yyyy HH:mm" />
                                                    </h:outputText>
                                                </p>
                                                <!-- Show if requires acknowledgment -->
                                                <h:panelGroup rendered="#{msgStatus.systemMessage.requiresAcknowledgment and !msgStatus.acknowledged}">
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-hand-index"></i> Requires Acknowledgment
                                                    </span>
                                                </h:panelGroup>
                                            </div>
                                        </div>
                                    </h:commandLink>
                                </li>
                                <h:panelGroup rendered="#{!status.last}">
                                    <li><hr class="dropdown-divider"/></li>
                                </h:panelGroup>
                            </ui:repeat>

                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <h:commandLink value="View All Notifications"
                                               action="/webUser/view_all_notifications"
                                               styleClass="dropdown-item text-center text-primary">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </h:commandLink>
                            </li>
                        </ul>
                    </li>

                    <!-- Logout -->
                    <li class="nav-item">
                        <h:commandLink styleClass="nav-link btn-logout" action="#{webUserController.logOut()}">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </h:commandLink>
                    </li>

                </h:form>
            </ul>
        </div>
    </cc:implementation>
</html>
