<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <body>

        <ui:composition template="/template.xhtml">

            <ui:define name="content">
                <h:form id="messageDetailForm">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4><i class="bi bi-envelope-open-fill"></i> Message Details</h4>

                                <!-- Language Selector -->
                                <div class="btn-group" role="group">
                                    <h:commandLink action="#{systemMessageController.setLanguage('si')}"
                                                   styleClass="btn btn-sm #{systemMessageController.currentLanguage == 'si' ? 'btn-light' : 'btn-outline-light'}">
                                        සිංහල
                                        <f:ajax execute="@this" render="messageContentPanel" />
                                    </h:commandLink>
                                    <h:commandLink action="#{systemMessageController.setLanguage('ta')}"
                                                   styleClass="btn btn-sm #{systemMessageController.currentLanguage == 'ta' ? 'btn-light' : 'btn-outline-light'}">
                                        தமிழ்
                                        <f:ajax execute="@this" render="messageContentPanel" />
                                    </h:commandLink>
                                    <h:commandLink action="#{systemMessageController.setLanguage('en')}"
                                                   styleClass="btn btn-sm #{systemMessageController.currentLanguage == 'en' ? 'btn-light' : 'btn-outline-light'}">
                                        English
                                        <f:ajax execute="@this" render="messageContentPanel" />
                                    </h:commandLink>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <h:panelGroup rendered="#{systemMessageController.selectedMessageStatus != null}">

                                <!-- Message Header -->
                                <div class="mb-4 pb-3 border-bottom">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi #{systemMessageController.selectedMessageStatus.systemMessage.messageType.icon} text-#{systemMessageController.selectedMessageStatus.systemMessage.messageType.colorClass} fs-2 me-3"></i>
                                        <div>
                                            <h3 class="mb-1">
                                                #{systemMessageController.selectedMessageStatus.systemMessage.subject}
                                            </h3>
                                            <small class="text-muted">
                                                <i class="bi bi-person-fill"></i> From: #{systemMessageController.selectedMessageStatus.systemMessage.creater.name}
                                                |
                                                <i class="bi bi-calendar-fill"></i>
                                                <h:outputText value="#{systemMessageController.selectedMessageStatus.systemMessage.createdAt}">
                                                    <f:convertDateTime pattern="MMM dd, yyyy HH:mm" />
                                                </h:outputText>
                                            </small>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="badge bg-#{systemMessageController.selectedMessageStatus.systemMessage.priority.colorClass} me-2">
                                            #{systemMessageController.selectedMessageStatus.systemMessage.priority.label} Priority
                                        </span>
                                        <span class="badge bg-secondary">
                                            #{systemMessageController.selectedMessageStatus.systemMessage.messageType.label}
                                        </span>
                                    </div>
                                </div>

                                <!-- Message Content in Selected Language -->
                                <h:panelGroup id="messageContentPanel" layout="block" styleClass="mb-4">
                                    <h:outputText value="#{systemMessageController.getMessageContent(systemMessageController.selectedMessageStatus.systemMessage)}"
                                                  escape="false"
                                                  styleClass="message-content" />
                                </h:panelGroup>

                                <!-- Attachments -->
                                <h:panelGroup rendered="#{not empty systemMessageController.selectedMessageStatus.systemMessage.attachments}">
                                    <div class="mb-4">
                                        <h5><i class="bi bi-paperclip"></i> Attachments:</h5>
                                        <div class="list-group">
                                            <ui:repeat value="#{systemMessageController.selectedMessageStatus.systemMessage.attachments}"
                                                       var="att">
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="bi bi-file-earmark-fill text-primary me-2"></i>
                                                        #{att.fileName}
                                                        <small class="text-muted ms-2">
                                                            (#{att.fileSize / 1024} KB)
                                                        </small>
                                                    </span>
                                                </div>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <!-- Acknowledgment Section -->
                                <h:panelGroup rendered="#{systemMessageController.selectedMessageStatus.systemMessage.requiresAcknowledgment}">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-hand-index-thumb-fill fs-4"></i>
                                        <strong class="ms-2">This message requires acknowledgment</strong>

                                        <h:panelGroup rendered="#{systemMessageController.selectedMessageStatus.acknowledged}">
                                            <div class="mt-3 alert alert-success">
                                                <i class="bi bi-check-circle-fill"></i>
                                                You acknowledged this message on
                                                <h:outputText value="#{systemMessageController.selectedMessageStatus.acknowledgedAt}">
                                                    <f:convertDateTime pattern="MMM dd, yyyy HH:mm" />
                                                </h:outputText>
                                            </div>
                                        </h:panelGroup>

                                        <h:panelGroup rendered="#{!systemMessageController.selectedMessageStatus.acknowledged}">
                                            <div class="mt-3">
                                                <p:commandButton value="I Acknowledge"
                                                                 icon="pi pi-check"
                                                                 action="#{systemMessageController.acknowledgeMessage(systemMessageController.selectedMessageStatus)}"
                                                                 update="@form"
                                                                 styleClass="ui-button-success" />
                                            </div>
                                        </h:panelGroup>
                                    </div>
                                </h:panelGroup>

                                <!-- Action Buttons -->
                                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                    <p:commandButton value="Back to All Notifications"
                                                     icon="pi pi-arrow-left"
                                                     action="/webUser/view_all_notifications"
                                                     styleClass="ui-button-secondary"
                                                     immediate="true" />

                                    <h:panelGroup rendered="#{systemMessageController.selectedMessageStatus.readAt != null and systemMessageController.selectedMessageStatus.dismissedAt == null}">
                                        <p:commandButton value="Dismiss Notification"
                                                         icon="pi pi-times"
                                                         action="#{systemMessageController.dismissMessage(systemMessageController.selectedMessageStatus)}"
                                                         update="@form"
                                                         styleClass="ui-button-warning">
                                            <p:confirm header="Confirmation"
                                                       message="Dismiss this notification from your notification area?"
                                                       icon="pi pi-info-circle" />
                                        </p:commandButton>
                                    </h:panelGroup>
                                </div>

                            </h:panelGroup>

                            <!-- Error if no message selected -->
                            <h:panelGroup rendered="#{systemMessageController.selectedMessageStatus == null}">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill"></i>
                                    No message selected. <h:link value="View all notifications" outcome="/webUser/view_all_notifications" />
                                </div>
                            </h:panelGroup>
                        </div>
                    </div>

                    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                        <p:commandButton value="Yes" type="button"
                                         styleClass="ui-confirmdialog-yes" />
                        <p:commandButton value="No" type="button"
                                         styleClass="ui-confirmdialog-no" />
                    </p:confirmDialog>

                </h:form>

            </ui:define>
        </ui:composition>
    </body>
</html>
